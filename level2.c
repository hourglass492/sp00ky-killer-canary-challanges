#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <signal.h>
#define debug 0

// char flag[] = "s00ky_ctf{n0W_we_4rE_901N9_S0MEWHERe}";
// python3 -c 'import sys; import struct; val = struct.pack("I", 0xdeadbeef); sys.stdout.buffer.write(b"A" * 32 + val)' | ./level2

char flag[] = {0x3a,0x71,0x63,0x2c,0x79,0x16,0x22,0x27,0x21,0x7b,0x27,0x71,0x4,0x18,0x77,0x2c,0x1e,0x67,0x35,0x45,0x16,0x78,0x63,0x76,0x4e,0x70,0x1e,0x0,0x77,0x4d,0xc,0x16,0x1b,0x2,0x52,0x2c,0x3c,0x53,0x47};

// char main_string[] = "main(){\n\n\n\
//     struct sigaction sa;\n\n\n\
//     \n\n\n\
//     memset(&sa, 0, sizeof(struct sigaction));\n\
//     sigemptyset(&sa.sa_mask);\n\
//     sa.sa_sigaction = segfault_sigaction;\n\
//     sa.sa_flags   = SA_SIGINFO;\n\
//     \n\
//     sigaction(SIGSEGV, &sa, NULL);\n\
//     \n\
//     \n\
//     struct data data = {\n\
//         .yourinput = { 0 },\n\
//         .give_flag = 0,\n\
//     };\n\
//     \n\
//     printf(\"Input:\");\n\
//     gets((char*) &data.yourinput);\n\
//     \n\
//     \n\
//     puts(\"\n\");\n\
//     puts((char*) &data.yourinput);\n\
//     \n\
//     if (data.give_flag == 0xDEADBEEF) {\n\
//         give_flag();\n\
//     \n\
//     }\n\
//     return 1;";

char main_string[] ={0x24,0x20,0x3a,0x29,0x28,0x60,0x3a,0x59,0x4d,0xa,0x69,0x61,0x73,0x67,0x73,0x3d,0x33,0x26,0x24,0x74,0x69,0x32,0x3a,0x20,0x61,0x2a,0x35,0x3a,0x28,0x6e,0x69,0x32,0x32,0x7c,0xa,0x43,0x4b,0x73,0x67,0x20,0x69,0x4b,0x59,0x4d,0x20,0x69,0x61,0x73,0x2a,0x65,0x24,0x32,0x36,0x33,0x28,0x6f,0x32,0x32,0x6b,0x20,0x79,0x6d,0x73,0x34,0x69,0x33,0x24,0x3c,0x21,0x28,0x3a,0x35,0x21,0x32,0x63,0x3d,0x61,0x20,0x2e,0x67,0x28,0x22,0x27,0x2e,0x6f,0x27,0x68,0x7a,0x7c,0xa,0x69,0x61,0x73,0x67,0x73,0x20,0x26,0x36,0x2a,0x70,0x3d,0x38,0x20,0x22,0x74,0x61,0x67,0x20,0x26,0x2e,0x3a,0x20,0xc,0x2a,0x61,0x3a,0x2a,0x7a,0x7c,0xa,0x69,0x61,0x73,0x67,0x73,0x28,0x6f,0x20,0x26,0x5f,0x3a,0x28,0x34,0x26,0x63,0x3d,0x28,0x3c,0x29,0x20,0x74,0x61,0x20,0x22,0x67,0x2f,0x20,0x26,0x2b,0x74,0x16,0x32,0x3a,0x20,0x61,0x2a,0x35,0x3a,0x28,0x6e,0x72,0x4b,0x73,0x67,0x20,0x69,0x32,0x32,0x69,0x73,0x28,0x1e,0x35,0x2b,0x61,0x2e,0x32,0x73,0x67,0x20,0x74,0x61,0x0,0x6,0x5f,0x1a,0x8,0x14,0xe,0x4e,0xf,0xe,0x68,0x4d,0x20,0x69,0x61,0x73,0x4d,0x20,0x69,0x61,0x73,0x34,0x69,0x2e,0x20,0x30,0x33,0x69,0x26,0x2f,0x7b,0x14,0x49,0xe,0x12,0x16,0x0,0x56,0x65,0x61,0x75,0x34,0x61,0x65,0x61,0x1d,0x12,0x4c,0x5,0x68,0x68,0x4d,0x20,0x69,0x61,0x73,0x4d,0x20,0x69,0x61,0x73,0x4d,0x20,0x69,0x61,0x73,0x34,0x74,0x3b,0x34,0x30,0x33,0x20,0x2d,0x20,0x27,0x26,0x20,0x2d,0x20,0x27,0x26,0x20,0x74,0x61,0x28,0x4d,0x20,0x69,0x61,0x73,0x67,0x20,0x69,0x61,0x7d,0x3e,0x6f,0x3c,0x33,0x3a,0x29,0x70,0x3c,0x35,0x73,0x7a,0x20,0x32,0x61,0x63,0x67,0x7d,0x65,0x4b,0x73,0x67,0x20,0x69,0x61,0x73,0x67,0x20,0x67,0x26,0x3a,0x31,0x65,0x16,0x27,0x3f,0x26,0x67,0x69,0x7c,0x73,0x77,0x2c,0x43,0x61,0x73,0x67,0x20,0x34,0x7a,0x59,0x67,0x20,0x69,0x61,0x59,0x67,0x20,0x69,0x61,0x23,0x35,0x69,0x27,0x35,0x35,0x6f,0x22,0x0,0x2f,0x23,0x32,0x74,0x73,0x63,0x7a,0x7c,0xa,0x69,0x61,0x73,0x67,0x67,0x2c,0x35,0x20,0x6f,0x28,0x2a,0x29,0x32,0x35,0x2a,0x60,0x61,0x75,0x23,0x61,0x3d,0x20,0x7d,0x3e,0x6f,0x3c,0x33,0x3a,0x29,0x70,0x3c,0x35,0x7a,0x7c,0xa,0x69,0x61,0x73,0x67,0xa,0x69,0x61,0x73,0x67,0xa,0x69,0x61,0x73,0x67,0x70,0x3c,0x35,0x20,0x6f,0x22,0x43,0x63,0x7a,0x7c,0xa,0x69,0x61,0x73,0x67,0x70,0x3c,0x35,0x20,0x6f,0x28,0x2a,0x29,0x32,0x35,0x2a,0x60,0x61,0x75,0x23,0x61,0x3d,0x20,0x7d,0x3e,0x6f,0x3c,0x33,0x3a,0x29,0x70,0x3c,0x35,0x7a,0x7c,0xa,0x69,0x61,0x73,0x67,0xa,0x69,0x61,0x73,0x67,0x69,0x2f,0x61,0x7b,0x23,0x61,0x3d,0x20,0x7d,0x20,0x69,0x3f,0x24,0xc,0x21,0x6c,0x28,0x26,0x73,0x7a,0x3d,0x69,0x71,0x2b,0x3,0x45,0x8,0x5,0x11,0x2,0x45,0xf,0x68,0x73,0x3c,0xa,0x69,0x61,0x73,0x67,0x20,0x69,0x61,0x73,0x20,0x69,0x3f,0x24,0xc,0x21,0x6c,0x28,0x26,0x7b,0x6e,0x3b,0x43,0x61,0x73,0x67,0x20,0x43,0x61,0x73,0x67,0x20,0x34,0x4b,0x73,0x67,0x20,0x69,0x33,0x36,0x33,0x75,0x3b,0x2f,0x73,0x76,0x3b,0x49,0x41};

signed long int actual_give;

struct data {
    char yourinput[30];
    signed long int give_flag;
};

void give_flag(char toPrint[], int size){


    puts("\n\n");

    // printf("size of input: %d\n", sizeof(toPrint));

    int i;

    char * key = "IASG";

    for(i = 0; i < size + 1; i++){
        toPrint[i] = toPrint[i] ^ key[i % 5];
        if (debug) printf("0x%x,", toPrint[i]);
    }

    puts("\n\n");


}


void segfault_sigaction(int signal, siginfo_t *si, void *arg)
{
    puts("Now why did you do that\nYou broke something, Now figure out how to fix it");


    give_flag(main_string, sizeof(main_string));
    puts(main_string);

    printf("\nalso your give flag was 0x%x\n", actual_give);


    exit(0);
}


int main(void) {


    struct sigaction sa;

    memset(&sa, 0, sizeof(struct sigaction));
    sigemptyset(&sa.sa_mask);
    sa.sa_sigaction = segfault_sigaction;
    sa.sa_flags   = SA_SIGINFO;

    sigaction(SIGSEGV, &sa, NULL);


    struct data data = {
        .yourinput = { 0 },
        .give_flag = 0,
    };

    printf("Welcome to the house, what are you doing wondering around at night? \n");
    gets((char*) &data.yourinput);

    printf("0x%x\n", data.give_flag);

    if (data.give_flag == 0xDEADBEEF) {
        give_flag(flag, sizeof(flag));
        printf("\nOh that's cool, I see we're alike, let me show you something: %s\n", flag);
    } else if ( data.give_flag){
        printf("Oh you think you're so cool changing my shit\n Well now my flag is %x and you have to go", data.give_flag);
        for(int i = 0; i < sizeof(flag); i++)
            flag[i] ^= flag[i]; 
    } else {
        puts("Oh really, I've never understood why people you do such a thing, goodbye");
        for(int i = 0; i < sizeof(flag); i++){
            flag[i] ^= flag[i]; 
    }

    }

    actual_give = data.give_flag;

    return 0;
}